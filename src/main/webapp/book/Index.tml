<html t:type="booklayout"
	xmlns:t="http://tapestry.apache.org/schema/tapestry_5_1_0.xsd"
	xmlns:p="tapestry:parameter">

	<t:security.ifAuthorOfBook t:bookId="bookId">
		<div class="book-admin">
			<ul>
				<t:if t:test="abstractHasWorkingCopy">
					<li><a t:type="pagelink" t:page="book" t:context="prop:abstractWorkingCopyCtx">Working Copy</a></li>
				</t:if>
				<li><a t:type="pagelink" t:page="chapter/edit" t:context="prop:editCtx">Edit Abstract</a></li>
				<li><a t:type="pagelink" t:page="book/settings" t:context="prop:bookId">Settings</a></li>
			</ul>
		</div>
	</t:security.ifAuthorOfBook>

	<ul id="exports" class="nav right-col">
		<li><a t:type="pagelink" t:page="chapter/issues" t:context="prop:issuesCtx">Issues</a></li>
		<li><a t:type="eventlink" t:event="print" t:name="prop:book.slugTitle">Export PDF</a></li>
	</ul>	  
  
	<h1><a href="#" t:type="pagelink" t:page="book/index" t:context="book?.id">${book?.title}</a></h1>

	<div id="meta">
  		<p id="authors">
  			By
  			<t:loop source="authors" value="currentUser" index="loopIdx">
  				${currentUser.fullname} <a t:type="pagelink" t:page="index" t:context="currentUser.username">${currentUser.username}</a>
  				<t:if test="isAntepenultiemIteration(loopIdx, authors.size())">
  					and
  					<p:else>
		  				<t:unless test="isLastIteration(loopIdx, authors.size())">, </t:unless>
  					</p:else>
  				</t:if>
  			</t:loop>
  		</p>
  		<p id="revision">Published <t:output value="prop:book?.creationDate" t:format="prop:format" /></p>
  	</div>

	<t:outputRaw value="content" />

	<h2>Table of contents</h2>
	
	<ol id="table-of-contents">
		<t:loop t:source="chaptersInfo" t:value="currentChapter">
			<li>
				<h3>
					<t:if t:test="published">
						<t:pagelink t:page="chapter/index" t:context="chapterCtx">${currentChapter.title}</t:pagelink>
						<p:else><span class="inactive">${currentChapter.title} <em>(not published) </em></span>
						</p:else>
					</t:if>
					
					<t:if t:test="showWorkingCopyLink">
						<t:security.ifAuthorOfBook t:bookId="bookId">
							<t:pagelink t:page="chapter/index" t:context="chapterWorkingCopyCtx"><em>Working copy</em></t:pagelink>
						</t:security.ifAuthorOfBook>
					</t:if>
		
				</h3>
				<p><t:lastModifiedFormatter t:time="currentChapter.lastModified?.time" /></p>
			</li>
		</t:loop>
		
		
		<t:security.ifAuthorOfBook t:bookId="bookId">
			<li>
				<t:zone id="addChapterZone" t:update="none">
					<t:delegate t:to="addChapterToggle" t:id="addChapterDelegate" />
				</t:zone>
			</li>
			
			<t:block id="addChapterLink">
				<h3>
					<t:actionlink class="active" t:id="showAddChapterField" t:zone="addChapterZone">Add a chapter</t:actionlink>
				</h3>
			</t:block>
			
			<t:block id="addChapterForm">
				<t:form t:id="addChapterForm" class="big-form">
					<h3>
						<t:textfield t:value="chapterName" class="long-field" t:validate="required" /><t:linksubmit class="radied-box active-button inline-form-button">Add</t:linksubmit>
					</h3>
					<p>
						<t:linkSubmit class="active-button radied-box inline-form-button">Cancel</t:linkSubmit>
					</p>
				</t:form>
			</t:block>
				
		</t:security.ifAuthorOfBook>
	</ol>	

	<t:commentBubbles t:publicationId="publicationId" t:bookId="book?.id" />

</html>
